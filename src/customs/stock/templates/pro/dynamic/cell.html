<!--<%inherit file="layout.html" /> -->
<!-- left is link
Author Wujj
Date : 2019/08/26
-->
<style>
  #leftgrid {
    width: 400px;
    height: 100%;
    float: left;
    margin-left: 6px !important;
    overflow-x: auto;
  }

  #cell {
    height: 100%;
    margin-left: 400px;

  }
</style>
<div style="width:100%;height: 100%;">
  <div id='leftgrid' class='leftgrid'>
    &nbsp;
  </div>
  <div id='cell'>
    &nbsp;
  </div>
</div>
<script type="text/javascript">
  var PCRUD;
  var Divisions = [];
  var Cid=GCtx.customer._id;
  var Cnm;
  var Uid = GCtx.user._id;
  var btnNn = "";
  var Loading = jQuery.Loading({ Message: "数据加载中……", Timeout: 1200 });
  var Title1 = "";
  var btnNm = "";
var pid;

  var oConfig = {
    columns: [
      [
        { "field": "table_nm", "title": "数据表名", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "table_field", "title": "数据字段", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "out_generate", "title": "生成输出", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "out_field", "title": "输出字段", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "rule", "title": "规则", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "group", "title": "cell分组", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "type", "title": "cell类型", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, binding: "CellType" },
        { "field": "sn", "title": "规则编码", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "w", "title": "排序", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
      ]
    ],
    form: [{
      "Title": "",
      "Inputs": [
        [{ "Field": "table_nm", "Name": "数据表名", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "table_field", "Name": "数据字段", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "out_generate", "Name": "生成输出", ShowType: "textarea", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
        ],
        [{ "Field": "out_field", "Name": "输出字段", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "rule", "Name": "规则", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "group", "Name": "cell分组", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
        ],
        [{ "Field": "type", "Name": "cell类型", ShowType: "combo", Ext: "CellType", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "sn", "Name": "规则编码", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
          { "Field": "w", "Name": "排序", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
        ],
      ]
    }],
    props: [],
    quics: [],
    leftColumns: [
      [
        { "field": "nm", "title": "规则名称", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "sn", "title": "规则编码", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },
        { "field": "require", "title": "是否必填", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, binding: "SF" },
        { "field": "w", "title": "排序", "align": "left", "halign": "center", "colspan": 1, "hidden": false, "rowspan": 1, "width": 100, },

      ]
    ],
    leftForm: [{
      "Title": "",
      "Inputs": [
        [
          { "Field": "nm", "Name": "规则名称", ShowType: "text", Ext: "", DataType: "String", "Required": true, RowSpan: 1, ColSpan: 1 },
          { "Field": "sn", "Name": "规则编码", ShowType: "text", Ext: "", DataType: "String", "Required": true, RowSpan: 1, ColSpan: 1 },
          { "Field": "require", "Name": "是否必填", ShowType: "combo", Ext: "SF", DataType: "Number", "Required": true, RowSpan: 1, ColSpan: 1 },
        ],
        [
          { "Field": "w", "Name": "排序", ShowType: "text", Ext: "", DataType: "String", "Required": false, RowSpan: 1, ColSpan: 1 },
        ],

      ]
    }],
    leftProps: [],
    leftQuics: [],

    leftInit: function() {
      LCRUD = jQuery.CRUD('#leftgrid', {
        View: {
          AfterRender: function() {
            this.Button.Hide(["filter", "order"]);



          },
          Form: {
            AfterEnable: function() {

            },
            AfterDisable: function() {

            },
            AfterSet: function(Record, IsNew) { // 点击新建后

              if (!IsNew) {
                //FormContainer.find(".button_container").css("display", "none");
              } else {

              }
            },
            BeforeGet: function(Record, u, Valids) {},
            AfterGet: function(Record, u, Valids) {

            },
            BeforeSet: function(Record, IsNew) {

            }
          }
        },
        Behavior: {
          BeforeQuery: function(Filters, Orders) {
            if (Cid) {
              Filters.Merge([{ Field: "cid", Operate: "=", Value: Cid, Relation: "and" }]);
 

              PCRUD.View.Button.Enable(["reset", "filter", "order", "column", "insert", "export"]);
              Loading.Show();
              return true;
            } else {
              PCRUD.View.Button.Disable(["reset", "filter", "order", "column", "insert", "export"]);
              return false;
            }
            Loading.Show();
          },
          AfterQuery: function(Result) {
            Loading.Hide();
            return true;
          },
          BeforeSave: function(Record, Callback) {
            if (Cid) {
              Record.cid = Cid;
              Record.cnm = Cnm;
            }

            return true;
          },
          AfterSave: function(Result) {
            //  PCRUD.View.Grid.Query();
            return true;
          },
          Grid: {
            //   RowDblClick: function (Row) {

            // },
            AfterRowClick: function(row) {
              pid=row._id;
              PCRUD.View.Grid.Query();
            }
          }
        },
        Service: {
          Path: "",
          Target: "link",
          Base: "/dynamic/"
        }
      }, {

        "Bindings": GBindings,
        "FrozenColumns": [
          []
        ],
        "Columns": this.leftColumns,
        "Form": this.leftForm,
        "Properties": this.leftProps,
        "Quicks": this.leftQuics,
        "Rights": "CUD",
        "Target": "cell",
        "Title": "",
        "ExportFmt": true,
        Layout: "POP" ? "POP" : "POP",
        ExportFoot: false,
        ExportName: ""

      });
    },
    init: function() {

      PCRUD = jQuery.CRUD('#cell', {
        View: {
          AfterRender: function() {
            this.Button.Hide(["filter", "order"]);



          },
          Form: {
            AfterEnable: function() {

            },
            AfterDisable: function() {

            },
            AfterSet: function(Record, IsNew) { // 点击新建后

              if (!IsNew) {

              } else {

              }
            },
            BeforeGet: function(Record, u, Valids) {},
            AfterGet: function(Record, u, Valids) {

            },
            BeforeSet: function(Record, IsNew) {

            }
          }
        },
        Behavior: {
          BeforeQuery: function(Filters, Orders) {
            if (Cid) {
              Filters.Merge([{ Field: "cid", Operate: "=", Value: Cid, Relation: "and" }]);
              PCRUD.View.Button.Enable(["reset", "filter", "order", "column", "insert", "export"]);
              Loading.Show();
              if(!pid){
                  return false;
              }else{
                Filters.Merge([{ Field: "__pid", Operate: "=", Value: pid, Relation: "and" }]);
              }
              return true;
            } else {
              PCRUD.View.Button.Disable(["reset", "filter", "order", "column", "insert", "export"]);
              return false;
            }
            Loading.Show();
          },
          AfterQuery: function(Result) {
            Loading.Hide();
            return true;
          },
          BeforeSave: function(Record, Callback) {
              if(!pid){
                  return false;
              }
            if (Cid) {
              Record.cid = Cid;
              Record.cnm = Cnm;
              Record.__pid = pid;
            }

            return true;
          },
          AfterSave: function(Result) {
            //  PCRUD.View.Grid.Query();
            return true;
          },
          Grid: {
            //   RowDblClick: function (Row) {

            // }
          }
        },
        Service: {
          Path: "link/",
          Target: "cell",
          Base: "../"
        }
      }, {

        "Bindings": GBindings,
        "FrozenColumns": [
          []
        ],
        "Columns": this.columns,
        "Form": this.form,
        "Properties": this.props,
        "Quicks": this.quics,
        "Rights": "CUD",
        "Target": "cell",
        "Title": "",
        "ExportFmt": true,
        Layout: "POP" ? "POP" : "POP",
        ExportFoot: false,
        ExportName: ""

      });


    }

  }


  jQuery(document).ready(function() {


    oConfig.leftInit();
    oConfig.init();

  });
</script>